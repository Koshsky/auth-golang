# CI/CD Пайплайн

## Обзор

Проект использует GitHub Actions для автоматизации процессов непрерывной интеграции и доставки (CI/CD). Пайплайн запускается при каждом push в ветки `master` и `develop`, а также при создании pull request'ов.

## Переменные окружения

- `GO_VERSION`: '1.24' - основная версия Go для сборки

## Этапы пайплайна

### 1. Тестирование (Test)

**Цель**: Запуск юнит-тестов и генерация отчетов о покрытии кода

**Матрица**: Тестирование на Go версиях 1.24 и 1.25

**Шаги**:
- Проверка кода из репозитория
- Настройка Go окружения с кэшированием
- Загрузка зависимостей (`go mod download`)
- Запуск тестов с включенной проверкой гонок данных:
  ```bash
  export CGO_ENABLED=1
  go test -v -race -coverprofile=coverage.out ./...
  ```
- Генерация HTML отчета о покрытии
- Загрузка артефакта с отчетом (только для Go 1.24)
- Вывод краткой сводки покрытия

**Артефакты**: 
- `coverage-report` - HTML отчет о покрытии кода (хранится 30 дней)

### 2. Линтинг (Lint)

**Цель**: Статический анализ кода для обнаружения потенциальных проблем

**Инструменты**: `golangci-lint` с timeout 5 минут

**Включенные линтеры**:
- `gofmt` - форматирование кода
- `goimports` - управление импортами
- `govet` - статический анализ
- `errcheck` - проверка обработки ошибок
- `staticcheck` - расширенный статический анализ
- `gosimple` - упрощение кода
- `ineffassign` - неиспользуемые присваивания
- `unused` - неиспользуемый код
- `misspell` - проверка орфографии
- `gosec` - анализ безопасности
- `prealloc` - оптимизация слайсов
- `gocritic` - критический анализ
- `revive` - расширенный линтер

**Исключения**:
- Папка `mocks/`
- Файлы `*.pb.go` (сгенерированные protobuf)
- Тестовые файлы `*_test.go` (для некоторых линтеров)

### 3. Сканирование безопасности (Security)

**Цель**: Обнаружение уязвимостей и проблем безопасности

**Инструменты**: `gosec`

**Шаги**:
- Установка gosec
- Запуск сканирования с выводом в формате SARIF
- Загрузка результатов в GitHub Security Advisory
- Отображение найденных проблем в логах

**Особенности**:
- Результаты загружаются только при push (не для PR)
- При отсутствии файла SARIF создается минимальный файл
- Процесс продолжается даже при ошибках

### 4. Docker сборка (Docker)

**Условия запуска**: 
- Только после успешного завершения тестов и линтинга
- Только при push в main/master или при создании тегов

**Шаги**:
- Настройка Docker Buildx для мультиплатформенной сборки
- Аутентификация в Docker Hub
- Извлечение метаданных для тегирования
- Сборка и публикация образа

**Поддерживаемые платформы**: 
- `linux/amd64`
- `linux/arm64`

**Стратегия тегирования**:
- `type=ref,event=branch` - имя ветки
- `type=ref,event=pr` - номер PR
- `type=semver,pattern={{version}}` - семантическая версия
- `type=semver,pattern={{major}}.{{minor}}` - мажорная.минорная
- `type=sha` - хэш коммита

**Кэширование**: Использует GitHub Actions cache для ускорения сборки

### 5. Релиз Docker (Docker Release)

**Условия запуска**: 
- Только при создании тегов
- После успешной сборки Docker образа

**Действия**:
- Создание GitHub Release с описанием
- Автоматическое формирование инструкций по использованию Docker образа

## Dockerfile

Образ строится на базе `golang:1.24-alpine` и включает:

**Компоненты**:
- `grpc_health_probe` для проверки состояния gRPC сервиса
- Базовые утилиты: git, wget, curl, netcat-openbsd
- Подготовленные директории для сертификатов

**Безопасность**:
- Создание и использование непривилегированного пользователя `appuser`
- Статическая сборка без CGO (`CGO_ENABLED=0`)
- Минимальный набор зависимостей

**Структура**:
```dockerfile
FROM golang:1.24-alpine
# Установка зависимостей
# Копирование и сборка приложения
# Настройка безопасности
EXPOSE 50051
USER appuser
CMD ["./auth-service"]
```

## Секреты

Для работы пайплайна необходимы следующие секреты в GitHub:

- `DOCKER_USERNAME` - имя пользователя Docker Hub
- `DOCKER_PASSWORD` - пароль или токен Docker Hub
- `GITHUB_TOKEN` - автоматически предоставляется GitHub

## Артефакты и результаты

1. **Coverage Report** - HTML отчет о покрытии кода тестами
2. **SARIF файл** - результаты сканирования безопасности
3. **Docker образы** - публикуются в Docker Hub
4. **GitHub Releases** - создаются для тегированных версий

## Мониторинг и отладка

- Все этапы выводят подробную информацию в логи
- Coverage summary отображается в выводе тестов
- Security findings выводятся в читаемом формате
- Docker metadata автоматически извлекается и используется

## Оптимизации производительности

1. **Кэширование Go модулей** - ускоряет установку зависимостей
2. **Docker layer caching** - использует GitHub Actions cache
3. **Параллельное выполнение** - тесты и линтинг запускаются независимо
4. **Условное выполнение** - Docker сборка только при необходимости
5. **Мультиплатформенная сборка** - один процесс для разных архитектур

## Расширение пайплайна

Для добавления новых этапов рекомендуется:

1. Добавлять новые job'ы в `.github/workflows/ci.yml`
2. Использовать зависимости между job'ами через `needs`
3. Добавлять соответствующие условия через `if`
4. Обновлять документацию при изменениях
